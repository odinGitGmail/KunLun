<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title></title>
</head>
<body>

<div class="container">
    <div class="row">&nbsp;</div>
    <div class="row">
        <div class="col-2">group</div>
        <div class="col-4"><input type="text" id="groupInput" /></div>
    </div>
    <div class="row">&nbsp;</div>
    <div class="row">
        <div class="col-2">User</div>
        <div class="col-4"><input type="text" id="userInput" /></div>
    </div>
    <div class="row">
        <div class="col-2">Message</div>
        <div class="col-4"><input type="text" id="messageInput" /></div>
    </div>
    <div class="row">&nbsp;</div>
    <div class="row">
        <div class="col-6">
            <input type="button" id="sendButton" value="Send Message" />
        </div>
        <div class="col-6">
            <input type="button" id="sendButton2" value="join group" />
        </div>
        <div class="col-6">
            <input type="button" id="sendButton3" value="Send Message group" />
        </div>
    </div>
</div>
<div class="row">
    <div class="col-12">
        <hr />
    </div>
</div>
<div class="row">
    <div class="col-6">
        <ul id="messagesList"></ul>
    </div>
</div>
<!--引入js文件-->
<script src="./node_modules/@microsoft/signalr/dist/browser/signalr.js"></script>


<script>

    //初始化客户端 官网 https://docs.microsoft.com/zh-cn/aspnet/core/signalr/javascript-client?view=aspnetcore-5.0&tabs=visual-studio
    var userId = '';
    //创建链接并指定到在StartUp中配置的Chathub的路由，
    const connection = new signalR.HubConnectionBuilder()
        .withUrl("/api/cola-signalr")
        .configureLogging(signalR.LogLevel.Information)
        .build();

//start开始连接，
async function start() {
    try {
        //会在后台触发连接Hub的Task OnConnectedAsync()方法，
        await connection.start();

        //如果想要在链接处获取身份信息，即使用/获取自带的UserID/Group对象什么的,
        //需要使用ASP.NET CORE 官方的authorize, 和Identity的相关内容，如果使用的是自研的登陆和认证内容，则无法使用以上的user对象
        //请手动发送empno/username等信息
        userId = connection.connectionId;
        console.log(`${connection.connectionId} - SignalR Connected.`);
        console.log();

    } catch (err) {
        console.log(err);
        //异步发起重连
        setTimeout(start, 5000);
    }
};

//重连机制
connection.onclose(async () => {
    await start();
});

//ReceiveMessage2为监听的数据标识，可自定义
//解释：当后台调用hub对象（IHubContext）SendAsync时，指定的第一个参数即为此标识时（或者直说第一个method参数等于此标识时），则前端会自动调用对应的函数，
//      后台的返回值则会注入到前端的参数中
connection.on("ReceiveMessageAsync", function (res) {
    var result = JSON.parse(res);
    //UI显示监听的数据
    var li = document.createElement("li");
    document.getElementById("messagesList").appendChild(li);
    li.textContent = `${result.data}`;
});


    connection.on("ReceivePrivateMessageAsync", function (res) {
        var result = JSON.parse(res);
        //UI显示监听的数据
        var li = document.createElement("li");
        document.getElementById("messagesList").appendChild(li);
        li.textContent = `${result.data}`;
    });

//发起连接
start();

//按钮事件（发送链接）
document.getElementById("sendButton").addEventListener("click", function (event) {
    var user = document.getElementById("userInput").value;
    var message = document.getElementById("messageInput").value;
    var sendMessage = `${user} say ${message}`
    // SendMessage2为自定义方法ChatHub.cs 定义的相同
    connection.invoke("SendMessageToOtherUserAsync", JSON.stringify({
        data : sendMessage
    })).catch(function (err) {
        return console.error(err.toString());
    });

    event.preventDefault();
});

//按钮事件（发送链接）
document.getElementById("sendButton2").addEventListener("click", function (event) {
    var group = document.getElementById("groupInput").value;
    var user = document.getElementById("userInput").value;
    var message = document.getElementById("messageInput").value;
    var sendMessage = `${user} say ${message}`
    // SendMessage2为自定义方法ChatHub.cs 定义的相同
    connection.invoke("AddToGroupAsync", group).catch(function (err) {
        return console.error(err.toString());
    });

    event.preventDefault();
});

//按钮事件（发送链接）
document.getElementById("sendButton3").addEventListener("click", function (event) {
    var group = document.getElementById("groupInput").value;
    var message = document.getElementById("messageInput").value;
    var user = document.getElementById("userInput").value;
    var sendMessage = `${user} say ${message}`
    // SendMessage2为自定义方法ChatHub.cs 定义的相同
    connection.invoke("SendMessageToGroupAsync", group, JSON.stringify({
        data : sendMessage
    })).catch(function (err) {
        return console.error(err.toString());
    });

    event.preventDefault();
});
</script>
</body>
</html>